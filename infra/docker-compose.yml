# Web Ranking Reports â€” MVP stack
# Run from repo root: docker compose -f infra/docker-compose.yml up -d

services:
  caddy:
    image: caddy:2-alpine
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    environment:
      - WEBRANKINGREPORTS_DOMAIN=${WEBRANKINGREPORTS_DOMAIN:-webrankingreports.com}
      - POCKETBASE_SUBDOMAIN=${POCKETBASE_SUBDOMAIN:-pb}
    depends_on:
      - web
      - pb

  web:
    build:
      context: ..
      dockerfile: infra/Dockerfile.web
      args:
        - NUXT_PUBLIC_POCKETBASE_URL=${NUXT_PUBLIC_POCKETBASE_URL:-https://pb.webrankingreports.com}
        - APP_URL=${APP_URL:-https://webrankingreports.com}
    image: web-ranking-reports-web
    restart: unless-stopped
    env_file:
      - .env
    # Explicitly pass server env. Production Nuxt only overrides runtimeConfig from NUXT_* env vars.
    environment:
      - HOST=0.0.0.0
      - PORT=3000
      - NODE_ENV=production
      - NUXT_PUBLIC_POCKETBASE_URL=${NUXT_PUBLIC_POCKETBASE_URL:-https://pb.webrankingreports.com}
      - APP_URL=${APP_URL:-https://webrankingreports.com}
      - NUXT_PUBLIC_APP_URL=${APP_URL:-https://webrankingreports.com}
      - PB_URL=${PB_URL:-http://pb:8090}
      - PB_ADMIN_EMAIL=${PB_ADMIN_EMAIL}
      - PB_ADMIN_PASSWORD=${PB_ADMIN_PASSWORD}
      - ADMIN_EMAILS=${ADMIN_EMAILS}
      - STATE_SIGNING_SECRET=${STATE_SIGNING_SECRET}
      # Nuxt runtimeConfig in production only reads NUXT_* prefixed vars
      - NUXT_PB_URL=${PB_URL:-http://pb:8090}
      - NUXT_PB_ADMIN_EMAIL=${PB_ADMIN_EMAIL}
      - NUXT_PB_ADMIN_PASSWORD=${PB_ADMIN_PASSWORD}
      - NUXT_ADMIN_EMAILS=${ADMIN_EMAILS}
      - NUXT_STATE_SIGNING_SECRET=${STATE_SIGNING_SECRET}
    expose:
      - "3000"
    # Expose 3000 on host so you can curl http://localhost:3000/api/... from the VPS (e.g. health/debug)
    ports:
      - "3000:3000"

  pb:
    build:
      context: .
      dockerfile: Dockerfile.pb
    restart: unless-stopped
    volumes:
      - pb_data:/pb_data
    environment:
      - POCKETBASE_DEBUG=0
    expose:
      - "8090"

volumes:
  caddy_data:
  caddy_config:
  pb_data:
